<p-growl styleClass="message-growl" [baseZIndex]="1050" [(value)]="msgs"></p-growl>

<p-dialog header="Confirmation" [(visible)]="displayDialog" [modal]="true" [responsive]="true" [style]="{width: '400px', minWidth: '200px'}" [minY]="70"
          [baseZIndex]="10000">
  <span *ngIf="!update_running && !reload_button" class="text-center"><p>The report was updated <b><u>{{last_update | date:'medium' }}</u></b>. Would you like to update it now ?</p></span>
  <span *ngIf="update_running && !reload_button" class="text-center">
    <p>Data update is ongoing. It will take a few minutes. Please wait...</p>
  </span>
  <span *ngIf="reload_button" class="text-center">
    Reload the page to see the latest changes
    <button class="btn btn-secondary" (click)="reloadPage()">
      <i class="fa fa-refresh"></i>
    </button>
  </span>
  <p-progressBar *ngIf="update_running" mode="indeterminate" [style]="{'height': '6px'}"></p-progressBar>
  <p-footer *ngIf="!reload_button">
    <button type="button" pButton icon="pi pi-check" iconPos="right" (click)="updateData()" label="Yes" [disabled]="update_running"></button>
    <button type="button" pButton icon="pi pi-close" iconPos="right" (click)="displayDialog=false" label="No" class="ui-button-secondary"></button>
  </p-footer>
</p-dialog>

<section class="assistant-report-filters">

  <form (ngSubmit)="submitFilters()" [formGroup]="reportsFilters">
    <div class="ui-g">

      <div class="ui-g-3">
        <div class="ui-g">
          <div class="ui-g-12 pb-0">
            <div class="input-group">
              <div class="input-group-prepend">
                <span class="input-group-text"><small>zip from</small></span>
              </div>
              <input type="text" formControlName="zipFrom"
                     class="form-control"
                     [ngClass]="{ 'is-invalid': submitted && f.zipFrom.errors }"
                     placeholder="From"/>
              <div *ngIf="submitted && f.zipFrom.errors" class="invalid-feedback">
                <div *ngIf="f.zipFrom.errors.pattern">Must be Number</div>
                <div *ngIf="f.zipFrom.errors.min">Must be more then 0</div>
                <div *ngIf="f.zipFrom.errors.max">Must be less then 9900</div>
              </div>
            </div>
          </div>
          <div class="ui-g-12 pt-0">
            <div class="input-group">
              <div class="input-group-prepend">
                <span class="input-group-text"><small>zip to</small></span>
              </div>
              <input type="text" formControlName="zipTo"
                     class="form-control"
                     [ngClass]="{ 'is-invalid': submitted && f.zipTo.errors }"
                     placeholder="To"/>
              <div *ngIf="submitted && f.zipTo.errors" class="invalid-feedback">
                <div *ngIf="f.zipTo.errors.pattern">Must be Number</div>
                <div *ngIf="f.zipTo.errors.min">Must be more then 0</div>
                <div *ngIf="f.zipTo.errors.max">Must be less then 10000</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="ui-g-3">
        <div class="ui-g">
          <div class="ui-g-12 pb-0">
            <div class="input-group">
              <div class="input-group-prepend">
                <span class="input-group-text"><small>employees from</small></span>
              </div>
              <input type="text" formControlName="emplFrom"
                     class="form-control"
                     [ngClass]="{ 'is-invalid': submitted && f.emplFrom.errors }"
                     placeholder="From"/>
              <div *ngIf="submitted && f.emplFrom.errors" class="invalid-feedback">
                <div *ngIf="f.emplFrom.errors.pattern">Must be Number</div>
                <div *ngIf="f.emplFrom.errors.min">Must be more then 0</div>
                <div *ngIf="f.emplFrom.errors.max">Must be less then 990000</div>
              </div>
            </div>
          </div>
          <div class="ui-g-12 pt-0">
            <div class="input-group">
              <div class="input-group-prepend">
                <span class="input-group-text"><small>employees to</small></span>
              </div>
              <input type="text" formControlName="emplTo"
                     class="form-control"
                     [ngClass]="{ 'is-invalid': submitted && f.emplTo.errors }"
                     placeholder="To"/>
              <div *ngIf="submitted && f.emplTo.errors" class="invalid-feedback">
                <div *ngIf="f.emplTo.errors.pattern">Must be Number</div>
                <div *ngIf="f.emplTo.errors.min">Must be more then 0</div>
                <div *ngIf="f.emplTo.errors.max">Must be less then 1000000</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="ui-g-3">
        <div class="ui-g">
          <div class="ui-g-12 pb-0">
            <div class="input-group">
              <div class="input-group-prepend">
                <span class="input-group-text"><small>turnover from</small></span>
              </div>
              <input type="text" formControlName="turnoverFrom"
                     class="form-control"
                     [ngClass]="{ 'is-invalid': submitted && f.turnoverFrom.errors }"
                     placeholder="From"/>
              <div *ngIf="submitted && f.turnoverFrom.errors" class="invalid-feedback">
                <div *ngIf="f.turnoverFrom.errors.pattern">Must be Number</div>
                <div *ngIf="f.turnoverFrom.errors.min">Must be more then 0</div>
                <div *ngIf="f.turnoverFrom.errors.max">Must be less then 999990000</div>
              </div>
            </div>
          </div>
          <div class="ui-g-12 pt-0">
            <div class="input-group">
              <div class="input-group-prepend">
                <span class="input-group-text"><small>turnover to</small></span>
              </div>
              <input type="text" formControlName="turnoverTo"
                     class="form-control"
                     [ngClass]="{ 'is-invalid': submitted && f.turnoverTo.errors }"
                     placeholder="To"/>
              <div *ngIf="submitted && f.turnoverTo.errors" class="invalid-feedback">
                <div *ngIf="f.turnoverTo.errors.pattern">Must be Number</div>
                <div *ngIf="f.turnoverTo.errors.min">Must be more then 0</div>
                <div *ngIf="f.turnoverTo.errors.max">Must be less then 1000000000</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="ui-g-3">
        <div class="ui-g">
          <div class="ui-g-12">
            <button pButton type="submit" label="Submit Filters"></button>
          </div>
        </div>
      </div>
    </div>
  </form>
  <div class="ui-g">
    <div class="ui-g-3 mb-1 range-date">
      <p-calendar class="float-right"
                  [(ngModel)]="monthDateStart"
                  (onSelect)="changeReportDate()"
                  view="month"
                  dateFormat="yy-mm"
                  [yearNavigator]="true"
                  yearRange="2019:2050">
      </p-calendar>
    </div>
    <div class="ui-md-9 mb-1 range-date">
      <mat-accordion>

        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <span *ngIf="monthDateEnd" class="mr-2" pTooltip="Delete range" tooltipPosition="left">
              <i class="fa fa-close" (click)="monthDateEnd = null; changeReportDate()"></i>
            </span>
            <span *ngIf="monthDateEnd">
              <small class="mr-2">Report range is from</small>
              <span class="range-data">{{monthDateStart | date: 'y, MMM'}}</span>
              <br>
              <span class="float-right">
                <small class="mr-2">to</small>
                <span class="range-data">{{monthDateEnd | date: 'y, MMM'}}</span>
              </span>
            </span>
            <span *ngIf="!monthDateEnd">
              <small class="mr-2">Report is until</small>
              <span class="range-data">{{monthDateStart | date: 'y, MMM'}}</span>
            </span>
            <hr/>
          </mat-expansion-panel-header>
          <p-calendar [style]="{'height': rangeCalendarHeight}"
                      [(ngModel)]="monthDateEnd"
                      (onFocus)="rangeCalendarHeight = '250px'"
                      (onSelect)="setDateRange();"
                      (onBlur)="rangeCalendarHeight = '0'"
                      view="month" dateFormat="yy-mm"
                      [yearNavigator]="true"
                      placeholder="Set range for Report"
                      yearRange="2015:2050">
          </p-calendar>
        </mat-expansion-panel>
      </mat-accordion>
    </div>
  </div>
</section>

<section *ngIf="reports">
  <ol class="list-group">
    <li class="list-group-item">
      <div class="ui-g">
        <div class="ui-g-12">
          <button class="btn btn-info float-right" (click)="showDialog()">Update Report</button>
        </div>
      </div>
    </li>
    <li *ngFor="let report of reports" class="list-group-item">
      <section>
        <table class="table table-info table-bordered">
          <tr>
            <th class="text-center" rowspan="3">{{report.assistant}}</th>
            <th class="text-center" rowspan="2">Projects</th>
            <th class="text-center" colspan="4">Companies</th>
            <th class="text-center" colspan="2">Working Time</th>
            <th class="text-center" colspan="2">Steps</th>
          </tr>
          <tr>
            <th class="text-center">Total</th>
            <th class="text-center">In Progress</th>
            <th class="text-center">Closed</th>
            <th class="text-center">Succeed</th>
            <th class="text-center">Performed</th>
            <th class="text-center">Total</th>
            <th class="text-center">Performed</th>
            <th class="text-center">Total</th>
          </tr>
          <tr>
            <td class="text-right">{{report.projects.length}}</td>
            <td class="text-right">{{report.total_companies}}</td>
            <td class="text-right">{{report.companies_in_progress}}</td>
            <td class="text-right">{{report.companies_closed}}</td>
            <td class="text-right">{{report.companies_succeed}}</td>
            <td class="text-right">{{report.time_performed * 24 | number:'1.0-0'}}</td>
            <td class="text-right">{{report.time_total * 24 | number:'1.0-0'}}</td>
            <td class="text-right">{{report.steps_performed}}</td>
            <td class="text-right">{{report.steps_total}}</td>
          </tr>
        </table>
      </section>
      <p-accordion>
        <p-accordionTab *ngFor="let project of report.projects" [header]="project.name">
          <p-table [value]="project.progresses">
            <ng-template pTemplate="header">
              <tr class="text-center">
                <th rowspan="3" colspan="2" class="width30">Company</th>
                <th colspan="7">Progress Data</th>
              </tr>
              <tr class="text-center">
                <th colspan="3">Companies</th>
                <th colspan="2">Working Time</th>
                <th colspan="2">Steps</th>
              </tr>
              <tr class="text-center">
                <th>In Progress</th>
                <th>Closed</th>
                <th>Succeed</th>
                <th>Performed</th>
                <th>Total</th>
                <th>Performed</th>
                <th>Total</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-progress>
              <tr class="text-center">
                <td colspan="2">{{progress.company}}</td>
                <td [ngClass]="{'in-progress-state': progress.in_progress === 1}"></td>
                <td [ngClass]="{'closed-state': progress.failed === 1}"></td>
                <td [ngClass]="{'succeed-state': progress.succeed === 1}"></td>
                <td>{{progress.steps_completed_time * 24 | number:'1.0-0'}}</td>
                <td>{{progress.steps_total_time * 24 | number:'1.0-0'}}</td>
                <td>{{progress.steps_completed}}</td>
                <td>{{progress.steps_total}}</td>
              </tr>
            </ng-template>
            <ng-template pTemplate="footer">
              <tr>
                <td>Totals</td>
                <td class="text-right">{{project.progresses.length}}</td>
                <td class="text-right">{{project.num_in_progress}}</td>
                <td class="text-right">{{project.num_closed}}</td>
                <td class="text-right">{{project.num_succeed}}</td>
                <td class="text-right">{{project.completed_steps_time * 24 | number:'1.0-0'}}</td>
                <td class="text-right">{{project.total_steps_time * 24 | number:'1.0-0'}}</td>
                <td class="text-right">{{project.completed_steps}}</td>
                <td class="text-right">{{project.total_steps}}</td>
              </tr>
            </ng-template>
          </p-table>
        </p-accordionTab>
      </p-accordion>
    </li>
  </ol>
</section>
